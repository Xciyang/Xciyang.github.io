<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="一个半退役OI的文化课选手...">
    <meta name="author" content="Ciyang">
    <meta name="keywords" content>
    <title>项目日记 - 开发图片爬虫 Ⅱ - Ciyang’s Blog</title>
    <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css?v=5.7.2">
    <link rel="stylesheet" href="/lib/mdbootstrap/css/bootstrap.min.css?v=4.3.1">
    <link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css?v=4.8.7">
    <link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_l7tuu6qerl9.css">
    
        <link rel="stylesheet" href="/lib/prettify/tomorrow-night-blue.min.css">
    
    <link rel="stylesheet" href="/css/main.css">

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?c285bfd3ab71dfa2d08b9656991e938e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css"></head>


<body>
<header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>Ciyang’s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">主页</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">归档</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/about/">关于</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2"
         style="background: url('/img/post.jpg')no-repeat center center;background-size: cover;">
        <div class="full-bg-img">
            <div class="mask rgba-black-light flex-center">
                <div class="container text-center white-text wow fadeInUp">
                    <span class="h2" id="subtitle">
                        
                    </span>
                    
                        <br>
                        <p>星期二, 五月 28日 2019, 8:54 晚上</p>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<main>
    
        <link rel="stylesheet" href="/css/post.css">



<div class="container-fluid">
    <div class="row">
        <div class="d-none d-lg-block col-lg-2"></div>
        <div class="col-lg-8 nopadding-md">
            <div class="container nopadding-md">
                <div class="py-5 z-depth-3 board">
                    <div class="post-content markdown-body m-auto">
                        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们上一节学习了获取网页的代码，那么大家可能会以为接下来就是分析网页了。但事实上，我们还需要先转换编码。我们都知道，C++编程常用的是ASCII编码，而网页大部分使用的是UTF-8编码。</p>
<p>因此我们要先将获取后的网页转换成我们想要的编码，再去分析内容。</p>
<h3 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h3><p>我们写编码转换的代码，肯定要知道这些编码之间的关系。</p>
<p>ASCII编码我们再熟悉不过了，然而我相信很多人和我一样，分不清什么是Unicode，UTF-8，UTF-16，UTF-32。</p>
<p>我不想用长篇大论来解释这些东西，就给出它们各自的定义和我们需要知道的东西。如果想更深入的了解，可以自行搜索。</p>
<blockquote>
<p>Unicode（统一码、万国码、单一码）是计算机科学领域里的一项业界标准，包括字符集、编码方案等。</p>
</blockquote>
<p>至于它为什么诞生，我简单说明一下。因为我们熟知的ASCII码能表示的字符是非常有限的，根本无法承受那么多国家的字符。因此国际组织就又发明了一个新的编码，几乎收尽所有国家的字符，甚至包括特殊字符。</p>
<p>Unicode与其他编码类似，也是每一个字符都对应一个数字来表示它。但Unicode也仅仅如此，它没有规定这个二进制代码如何存储。</p>
<p>那么问题来了，在Unicode编码下，假设有一个3字节的二进制代码，计算机怎么知道表示的是一个字符还是两个字符或者是三个字符呢？因此UTF-8、UTF-16这一系列东西就诞生了。</p>
<p>先介绍UTF-8，这是开发网页首选的编码存储方式。</p>
<blockquote>
<p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，又称万国码，由Ken Thompson于1992年创建。</p>
</blockquote>
<p>如果略懂编码的话，可变长度是最大特点。但是为了实现可变长度，就需要一些二进制位来表示长度，我认为它的编码规则可以说是非常典型了。</p>
<table>
<thead>
<tr>
<th>字节数</th>
<th>二进制编码形式</th>
</tr>
</thead>
<tbody><tr>
<td>1字节</td>
<td>0xxxxxxx</td>
</tr>
<tr>
<td>2字节</td>
<td>110xxxxx 10xxxxxx</td>
</tr>
<tr>
<td>3字节</td>
<td>1110xxxx 10xxxxxx 10xxxxxx</td>
</tr>
<tr>
<td>4字节</td>
<td>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</td>
</tr>
<tr>
<td>5字节</td>
<td>111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx</td>
</tr>
<tr>
<td>6字节</td>
<td>1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx</td>
</tr>
</tbody></table>
<p>再简单说一下UTF-16，定义：</p>
<blockquote>
<p>UTF-16是Unicode字符编码五层次模型的第三层：字符编码表（Character Encoding Form，也称为 “storage format”）的一种实现方式。</p>
</blockquote>
<p>UTF-16虽然也可变长度，但不如UTF-8灵活。它有大尾序和小尾序两种储存形式，这个可以自行查阅。</p>
<blockquote>
<p>UTF-32 (或 UCS-4)是一种将Unicode字符编码的协定，对每一个Unicode码位使用恰好32位元。其它的Unicode transformation formats则使用不定长度编码。</p>
</blockquote>
<p>网上找到一个工具，<a href="https://www.qqxiuzi.cn/bianma/Unicode-UTF.php" target="_blank" rel="noopener">Unicode和UTF编码转换</a>，有兴趣可以试一下。</p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>我们为什么要了解上面那些东西，最终还是为了更容易理解代码。先给出一个将一个字符串从UTF-8转为ASCII的示例代码，从网上抄下来的。</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">changeTxtEncoding</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>szU8<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> wcsLen<span class="token operator">=</span> <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span>CP_UTF8<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> szU8<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>szU8<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">wchar_t</span> <span class="token operator">*</span>wszString<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">wchar_t</span><span class="token punctuation">[</span>wcsLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span>CP_UTF8<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> szU8<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>szU8<span class="token punctuation">)</span><span class="token punctuation">,</span> wszString<span class="token punctuation">,</span> wcsLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wszString<span class="token punctuation">[</span>wcsLen<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ansiLen<span class="token operator">=</span> <span class="token function">WideCharToMultiByte</span><span class="token punctuation">(</span>CP_ACP<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> wszString<span class="token punctuation">,</span> <span class="token function">wcslen</span><span class="token punctuation">(</span>wszString<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>szAnsi<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>ansiLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">WideCharToMultiByte</span><span class="token punctuation">(</span>CP_ACP<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> wszString<span class="token punctuation">,</span> <span class="token function">wcslen</span><span class="token punctuation">(</span>wszString<span class="token punctuation">)</span><span class="token punctuation">,</span> szAnsi<span class="token punctuation">,</span> ansiLen<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    szAnsi<span class="token punctuation">[</span>ansiLen<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> wszString<span class="token punctuation">;</span>
    <span class="token keyword">return</span> szAnsi<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>此函数是将一个字符串，先从UTF-8转为UTF-16，再转为ASCII。</p>
<h4 id="MultiByteToWideChar"><a href="#MultiByteToWideChar" class="headerlink" title="MultiByteToWideChar"></a>MultiByteToWideChar</h4><p>此函数可将字符串映射到UTF-16(宽字符)字符串。字符串不一定来自多字节字符集。在这里，字符集或代码页我们都可以理解为编码映射表。</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> WINAPI <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span>
    _In_ UINT CodePage<span class="token punctuation">,</span>
    _In_ DWORD dwFlags<span class="token punctuation">,</span>
    <span class="token function">_In_NLS_string_</span><span class="token punctuation">(</span>cbMultiByte<span class="token punctuation">)</span> LPCCH lpMultiByteStr<span class="token punctuation">,</span>
    _In_ <span class="token keyword">int</span> cbMultiByte<span class="token punctuation">,</span>
    <span class="token function">_Out_writes_to_opt_</span><span class="token punctuation">(</span>cchWideChar<span class="token punctuation">,</span><span class="token keyword">return</span><span class="token punctuation">)</span> LPWSTR lpWideCharStr<span class="token punctuation">,</span>
    _In_ <span class="token keyword">int</span> cchWideChar
    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>定义简化如下：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> WINAPI <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span>
    UINT CodePage<span class="token punctuation">,</span> 
    DWORD dwFlags<span class="token punctuation">,</span> 
    LPCCH lpMultiByteStr<span class="token punctuation">,</span> 
    <span class="token keyword">int</span> cbMultiByte<span class="token punctuation">,</span> 
    LPWSTR lpWideCharStr<span class="token punctuation">,</span> 
    <span class="token keyword">int</span> cchWideChar
    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><em>CodePage</em>为指定执行转换的字符集。如果原字符串为ASCII通常选择CP_ACP，关于CP_ACP与CP_THREAD_ACP的区别可以自己了解。我们这里原字符串为UTF-8，因此选择CP_UTF8。数值表：</p>
<table>
<thead>
<tr>
<th>数值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>CP_ACP</td>
<td>Windows系统默认的ANSI代码页。</td>
</tr>
<tr>
<td>CP_MACCP</td>
<td>Mac系统代码页。</td>
</tr>
<tr>
<td>CP_ACP</td>
<td>OEM系统代码页。</td>
</tr>
<tr>
<td>CP_SYMBOL</td>
<td>符号字符集。</td>
</tr>
<tr>
<td>CP_THREAD_ACP</td>
<td>当前Windows线程的ANSI代码页。</td>
</tr>
<tr>
<td>CP_UTF7</td>
<td>使用UTF-7。</td>
</tr>
<tr>
<td>CP_UTF8</td>
<td>使用UTF-8。</td>
</tr>
</tbody></table>
<p><em>dwFlags</em>设定转换类型。缺省值为MB_PRECOMPOSED，对于UTF-8必须为0或MB_ERR_INVALID_CHARS，此参数作用较小，数值表就不给出了。</p>
<p><em>lpMultiByteStr</em>指向一个要转换的字符串。</p>
<p><em>cbMultiByte</em>指定长度，如果lpMultiByteStr指向的字符串为空结束，此参数可设为-1。如果设为-1，函数将处理包括终止空字符在内的所有字符。我们可以用strlen来自行获得长度。</p>
<p><em>lpWideCharStr</em>为指向接收缓冲器的指针。</p>
<p><em>cchWideChar</em>为lpWideCharStr指示的缓冲器的大小(以字符为单位)。如果此值为0不使用lpWideCharStr缓冲区。</p>
<p><em>Return Value</em>即返回值，返回写入到缓冲器的字符数。如果cchWideChar为0则返回缓冲器所需大小(以字符为单位)。</p>
<p>我们第一次调用此函数时应将cchWideChar设为0，并记录函数返回值，第二次调用时将cchWideChar设为此值。</p>
<h4 id="WideCharToMultiByte"><a href="#WideCharToMultiByte" class="headerlink" title="WideCharToMultiByte"></a>WideCharToMultiByte</h4><p>与MultiByteToWideChar恰恰相反，但多两个参数，此函数可将UTF-16(宽字符)字符串映射到新字符串。</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> WINAPI <span class="token function">WideCharToMultiByte</span><span class="token punctuation">(</span>
    UINT CodePage<span class="token punctuation">,</span> 
    DWORD dwFlags<span class="token punctuation">,</span> 
    LPCWCH lpWideCharStr<span class="token punctuation">,</span> 
    <span class="token keyword">int</span> cchWideChar<span class="token punctuation">,</span> 
    LPSTR lpMultiByteStr<span class="token punctuation">,</span> 
    <span class="token keyword">int</span> cbMultiByte<span class="token punctuation">,</span> 
    LPCCH lpDefaultChar<span class="token punctuation">,</span> 
    LPBOOL lpUsedDefaultChar
    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><em>CodePage</em>为指定执行转换的字符集。可选数值与MultiByteToWideChar相同，我们这里选择CP_ACP。</p>
<p><em>dwFlags</em>设定转换类型。设为0即可。</p>
<p><em>lpWideCharStr</em>指向一个要转换的字符串。</p>
<p><em>cchWideChar</em>指定长度。对于宽字符，自行使用wcslen来获得。</p>
<p><em>lpMultiByteStr</em>为指向接收缓冲器的指针。</p>
<p><em>cbMultiByte</em>为lpMultiByteStr指示的缓冲器的大小(以字符为单位)。</p>
<p><em>lpDefaultChar</em>为指向另一个接收缓冲器的指针，如果某个字符不能在指定的代码页中表示将使用此缓冲器。我们不需要，设为NULL即可。</p>
<p><em>lpUsedDefaultChar</em>为一个指向BOOL变量的指针。如果使用了lpDefaultChar将被设为TRUE，否则为FALSE。我们也设为NULL即可。</p>
<p><em>Return Value</em>即返回值，与MultiByteToWideChar相类比。</p>
<p>调用两次，步骤也与MultiByteToWideChar相似。</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p>网上给的代码没有释放内存的语句，可能会造成内存泄露。</p>
<p><em>delete</em>语句使用过指针都知道，释放一个指针指向的内存。</p>
<p><em>delete[]</em>语句释放一个数组指针指向的内存。</p>
<p>如果想深入了解其中的原理，可以自行查阅。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这一节简单介绍了编码的知识和使用C++进行编码转换的代码。我们这个项目深入了解编码系统，所介绍的也不过是冰山一角。</p>
<p>现在大家已经可以自己写代码对网页进行简单分析了。下一节我打算介绍关于WinHTTP的内容和用途。</p>

                        <hr>
                        <div>
                            <p>
                                
                                    <span class="badge badge-light">#&nbsp;Cpp</span>
                                    &nbsp;
                                
                                    <span class="badge badge-light">#&nbsp;颓废</span>
                                    &nbsp;
                                
                                    <span class="badge badge-light">#&nbsp;项目</span>
                                    &nbsp;
                                
                                    <span class="badge badge-light">#&nbsp;爬虫</span>
                                    &nbsp;
                                
                            </p>
                        </div>
                        <br>
                        
                            <p class="note note-warning">本博客所有文章由作者 Ciyang 所有，转载请注明出处！</p>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="d-none d-lg-block col-lg-2 toc-container">
            
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="comments" id="comments">
    
        <br><br>
        
        
<div id="vcomments" style="width: 80%;margin: 0 auto;"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
   var notify = 'false' == true ? true : false;
   var verify = 'true' == true ? true : false;
    window.onload = function() {
        new Valine({
            el: '#vcomments',
            notify: notify,
            verify: verify,
            app_id: "7BQ3ob3WSCRNqx6hDwbdTSnG-gzGzoHsz",
            app_key: "XIkONR2UXsu6jiyIL9VzPSuA",
            placeholder: "水一下评论?",
            avatar:"retro",
            meta: ['nick','mail','link'],
            pageSize: "10",
            visitor: "true"
        });
    };
</script>
<noscript>Please enable JavaScript to view the <a href="https://valine.js.org" rel="nofollow noopener">comments powered by Valine.</a></noscript>

    
</div>
    
</main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Ciyang</b></a>
    <i class="iconfont icon-love"></i><br>
    
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="/lib/mdbootstrap/js/jquery-3.4.1.min.js"></script>
  <script src="/lib/mdbootstrap/js/popper.min.js"></script>
  <script src="/lib/mdbootstrap/js/bootstrap.min.js?v=4.3.1"></script>
  <script src="/lib/mdbootstrap/js/mdb.min.js?v=4.8.7"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="/lib/tocbot/tocbot.min.js?v=4.7.0"></script>
    
    <script src="/js/post.js"></script>
  
  
    <script src="/lib/prettify/prettify.min.js?v=0.1.0"></script>
    <script>
      $(document).ready(function(){
        $('pre').addClass('prettyprint linenums');
        prettyPrint();
      })
    </script>
  
  
    <script src="/lib/typed/typed.min.js?v=2.0.9"></script>
    <script>
        var typed = new Typed('#subtitle', {
          strings: [
            '  ',
            "项目日记 - 开发图片爬虫 Ⅱ&nbsp;",
        ],
        cursorChar: "|",
        typeSpeed: 50,
        startDelay: 300, //开始之前延迟300毫秒
        loop: false,
        });
        $(".typed-cursor").addClass("h2");
    </script>
  
  
    <script src="/lib/anchor/anchor.min.js?v=4.2.0"></script>
    <script>
      anchors.options = {
        placement: "right",
        visible: "false",
        
      };
      anchors.add(".post-content > h1,h2,h3,h4,h5,h6");
    </script>
  
</body>
</html>